<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catan Fair Generator Pro - v4.7.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body { font-family: 'Inter', sans-serif; }
        .hex-path { stroke: rgba(0,0,0,0.15); stroke-width: 1.5; transition: all 0.2s; cursor: pointer; }
        .hex-path:hover { stroke: rgba(255,255,255,0.5); filter: brightness(1.1); }
        .hex-label { pointer-events: none; user-select: none; font-weight: 900; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .node-marker {
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-box: fill-box;
            transform-origin: center;
        }
        .node-marker:hover { transform: scale(1.25); }

        .road-line { stroke-width: 8; stroke-linecap: round; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); transition: opacity 0.3s; }

        .player-1 { fill: #2563eb; stroke: #1e3a8a; } .road-1 { stroke: #2563eb; }
        .player-2 { fill: #fbbf24; stroke: #b45309; } .road-2 { stroke: #fbbf24; }
        .player-3 { fill: #ef4444; stroke: #991b1b; } .road-3 { stroke: #ef4444; }
        .player-4 { fill: #f8fafc; stroke: #64748b; } .road-4 { stroke: #f8fafc; }
        .player-5 { fill: #22c55e; stroke: #14532d; } .road-5 { stroke: #22c55e; }
        .player-6 { fill: #a855f7; stroke: #581c87; } .road-6 { stroke: #a855f7; }

        .player-text-4 { fill: #1e293b !important; }
        .port-line { stroke: #1e293b; stroke-width: 5; stroke-linecap: round; opacity: 0.6; }
        .port-bg { stroke: white; stroke-width: 2; cursor: pointer; transition: all 0.2s; transform-box: fill-box; transform-origin: center; }
        .port-bg:hover { transform: scale(1.3); }

        #mapContainer { cursor: grab; overflow: hidden; touch-action: none; background: radial-gradient(circle, #0096c7 0%, #0077b6 100%); }
        #mapContainer:active { cursor: grabbing; }

        .resource-icon { pointer-events: none; opacity: 0.15; }
        .settlement-badge { font-size: 10px; font-weight: 900; fill: #1e293b; paint-order: stroke; stroke: white; stroke-width: 3px; pointer-events: none; }

        #sideModal { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-open #sideModal { transform: translateX(0); }
        .stat-bar { transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .robber-icon { fill: #334155; stroke: #1e293b; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); pointer-events: none; }
        .pirate-icon { fill: #0f172a; stroke: white; stroke-width: 1; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); pointer-events: none; }

        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-900 overflow-x-hidden text-sm font-medium">

<div class="max-w-[1600px] mx-auto p-4 md:p-8">
    <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-6">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <span class="bg-orange-500 text-white text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-widest">Version 4.7.9</span>
                <span class="text-slate-400 text-xs font-bold uppercase tracking-widest italic text-sm text-slate-500">Connected Desert Logic</span>
            </div>
            <h1 class="text-4xl font-black text-slate-900 tracking-tighter">Catan Fair Generator <span class="text-orange-500 underline decoration-4 underline-offset-4">PRO</span></h1>
        </div>
        <div class="flex gap-2">
            <button onclick="window.app.generate()" class="bg-slate-900 hover:bg-black text-white px-8 py-4 rounded-2xl shadow-xl shadow-slate-200 transition-all active:scale-95 font-black uppercase tracking-widest text-sm flex items-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Generuj Nowy Uk≈Çad
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <aside class="lg:col-span-3 space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 space-y-6">
                <section>
                    <label class="text-[11px] font-black text-slate-400 uppercase mb-3 block tracking-widest">Konfiguracja Gry</label>
                    <div class="grid grid-cols-1 gap-3">
                        <select id="playerCount" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-orange-500 outline-none font-bold text-slate-700 transition-all cursor-pointer">
                            <option value="3">3 Graczy</option>
                            <option value="4" selected>4 Graczy</option>
                            <option value="5">5 Graczy</option>
                            <option value="6">6 Graczy</option>
                        </select>
                        <select id="scenario" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-orange-500 outline-none font-bold text-slate-700 transition-all cursor-pointer">
                            <option value="base">Gra Podstawowa</option>
                            <option value="shores">‚õµ Nowe lƒÖdy</option>
                            <option value="islands">‚õµ Cztery Wyspy</option>
                        </select>
                    </div>
                </section>

                <section class="pt-4 border-t border-slate-100">
                    <label class="text-[11px] font-black text-slate-400 uppercase mb-3 block tracking-widest">Zasady Balansu</label>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-xs font-bold text-slate-600">Restrykcyjne 6/8</span>
                            <input type="checkbox" id="strictRules" checked class="w-5 h-5 accent-orange-500">
                        </label>
                        <label class="flex items-center justify-between p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-xs font-bold text-slate-600">Poka≈º Drogi Startowe</span>
                            <input type="checkbox" id="showRoads" checked class="w-5 h-5 accent-orange-500">
                        </label>
                    </div>
                </section>

                <section class="pt-4 border-t border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Zoom Mapy</label>
                        <span id="zoomVal" class="text-[10px] font-black text-orange-500">100%</span>
                    </div>
                    <input type="range" id="zoomSlider" min="0.4" max="2.5" step="0.1" value="1" class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-orange-500">
                </section>
            </div>

            <div id="statsPanel" class="hidden bg-white p-6 rounded-3xl shadow-sm border border-slate-200 space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest border-b pb-3 text-center italic">Analiza Produkcji</h3>
                <div id="playerStats" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 scrollbar-thin"></div>
            </div>
        </aside>

        <main class="lg:col-span-9 relative group">
            <div class="absolute top-6 left-6 z-10 flex gap-2">
                <div class="bg-white/80 backdrop-blur px-4 py-2 rounded-full text-[10px] font-black shadow-sm border border-white/20 uppercase tracking-widest text-slate-600">
                    Tryb: <span id="activeScenarioName" class="text-slate-900">Standard</span>
                </div>
            </div>

            <div class="bg-slate-300 rounded-[40px] p-1 h-[750px] lg:h-[850px] relative overflow-hidden shadow-2xl border-4 border-white">
                <div id="loadingOverlay" class="absolute inset-0 bg-white/80 z-30 flex flex-col items-center justify-center hidden backdrop-blur-md">
                    <div class="relative">
                        <div class="animate-spin rounded-full h-24 w-24 border-b-4 border-orange-500"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-orange-600 uppercase">CALC</div>
                    </div>
                    <p class="mt-6 text-sm font-black text-slate-800 uppercase tracking-widest animate-pulse text-center">Optymalizacja mapy...</p>
                </div>

                <div id="mapContainer" class="w-full h-full">
                    <svg id="mapCanvas" class="w-full h-full transition-transform duration-100 ease-out">
                        <defs>
                            <g id="icon-forest"><path d="M0 -15 L10 5 L-10 5 Z M0 -5 L8 10 L-8 10 Z" /></g>
                            <g id="icon-clay"><rect x="-10" y="-8" width="20" height="16" rx="2" /></g>
                            <g id="icon-wheat"><path d="M-5 10 Q0 0 5 -10 M5 10 Q0 0 -5 -10" fill="none" stroke="currentColor" stroke-width="2"/></g>
                            <g id="icon-sheep"><circle cx="0" cy="0" r="10" /><circle cx="7" cy="-5" r="4" /></g>
                            <g id="icon-ore"><path d="M-12 8 L0 -12 L12 8 L0 12 Z" /></g>
                            <g id="icon-gold"><path d="M-10 -10 L10 -10 L15 0 L10 10 L-10 10 L-15 0 Z" /></g>
                        </defs>
                    </svg>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden opacity-0 transition-opacity duration-300" onclick="window.app.closeModal()"></div>
<div id="sideModal" class="fixed top-0 right-0 h-full w-full max-md bg-white shadow-[-20px_0_50px_rgba(0,0,0,0.1)] z-[101] transform translate-x-full overflow-y-auto flex flex-col text-slate-900">
    <div class="p-8 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
        <div>
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Inspektor Obiektu</p>
            <h2 id="modalTitle" class="text-2xl font-black text-slate-900 tracking-tight text-slate-900">Szczeg√≥≈Çy</h2>
        </div>
        <button onclick="window.app.closeModal()" class="p-4 hover:bg-slate-100 rounded-2xl transition-all"><svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>
    <div id="modalContent" class="p-8 space-y-8 flex-1"></div>
</div>

<script>
    const COLORS = { forest:'#1b4332', clay:'#bc4749', wheat:'#fef08a', sheep:'#a7c957', ore:'#4a4e69', desert:'#e9c46a', gold:'#ffb703', playableSea: '#00b4d8', borderTile: '#0096c7', borderSea: '#0077b6' };
    const RESOURCE_LABELS = { forest:'Drewno', clay:'Glina', wheat:'Zbo≈ºe', sheep:'Owce', ore:'Ruda', desert:'Pustynia', gold:'Z≈Çoto', any: '3:1', border: 'Ocean' };
    const PP_MAP = { 0:0, 2:1, 3:2, 4:3, 5:4, 6:5, 8:5, 9:4, 10:3, 11:2, 12:1 };

    const SCENARIOS = {
        base: {
            3: { layout: ["mmm", "mmmm", "mmmmm", "mmmm", "mmm"], resources: {forest:4, wheat:4, sheep:4, clay:3, ore:3, desert:1}, numbers: [2, 3, 3, 4, 4, 5, 5, 6, 6, 8, 8, 9, 9, 10, 10, 11, 11, 12], ports: [{q:0, r:-2, e:4, t:'any'}, {q:1, r:-2, e:5, t:'wheat'}, {q:-1, r:-1, e:3, t:'forest'}, {q:2, r:-1, e:5, t:'ore'}, {q:2, r:0, e:0, t:'any'}, {q:-2, r:1, e:3, t:'clay'}, {q:1, r:1, e:1, t:'sheep'}, {q:-2, r:2, e:2, t:'any'}, {q:-1, r:2, e:1, t:'any'}] },
            4: { layout: ["mmm", "mmmm", "mmmmm", "mmmm", "mmm"], resources: {forest:4, wheat:4, sheep:4, clay:3, ore:3, desert:1}, numbers: [2, 3, 3, 4, 4, 5, 5, 6, 6, 8, 8, 9, 9, 10, 10, 11, 11, 12], ports: [{q:0, r:-2, e:4, t:'any'}, {q:1, r:-2, e:5, t:'wheat'}, {q:-1, r:-1, e:3, t:'forest'}, {q:2, r:-1, e:5, t:'ore'}, {q:2, r:0, e:0, t:'any'}, {q:-2, r:1, e:3, t:'clay'}, {q:1, r:1, e:1, t:'sheep'}, {q:-2, r:2, e:2, t:'any'}, {q:-1, r:2, e:1, t:'any'}] },
            5: {
                layout: ["mmm", "mmmm", "mmmmm", "mmmmmm", "mmmmm", "mmmm", "mmm"],
                resources: {forest:6, wheat:6, sheep:6, clay:5, ore:5, desert:2},
                numbers: [2,2, 3,3,3, 4,4,4, 5,5,5, 6,6,6, 8,8,8, 9,9,9, 10,10,10, 11,11,11, 12,12],
                ports: [
                    {q:1, r:-3, e:4, t:'any'},
                    {q:2, r:-3, e:5, t:'sheep'},
                    {q:3, r:-2, e:5, t:'any'},
                    {q:-1, r:-1, e:3, t:'ore'},
                    {q:3, r:0, e:0, t:'any'},
                    {q:-2, r:1, e:3, t:'sheep'},
                    {q:2, r:1, e:1, t:'clay'},
                    {q:-2, r:2, e:3, t:'wheat'},
                    {q:-2, r:3, e:2, t:'any'},
                    {q:-1, r:3, e:1, t:'forest'},
                    {q:0, r:3, e:0, t:'any'}
                ]
            }
        },
        shores: {
            3: { layout: ["llww", "wwwll", "wmmwlw", "wmmmwlw", "mmmmww", "mmmwl", "mmwl"], resources: {forest:3, wheat:4, sheep:5, clay:4, ore:4, gold:2}, numbers: [2, 3,3, 4,4,4, 5,5,5, 6,6, 8,8,8, 9,9, 10,10,10, 11,11, 12], ports: [{q:-1, r:-1, e:3, t:'wheat'}, {q:0, r:-1, e:0, t:'any'}, {q:-3, r:1, e:4, t:'ore'}, {q:-3, r:1, e:2, t:'any'}, {q:0, r:1, e:5, t:'sheep'}, {q:-3, r:3, e:3, t:'clay'}, {q:-2, r:3, e:2, t:'forest'}, {q:-2, r:3, e:0, t:'any'}] },
            4: { layout: ["llwlw", "wwwwll", "wmmmwlw", "wmmmmwlw", "mmmmmww", "mmmmwl", "mmmwl"], resources: {forest:5, wheat:5, sheep:5, clay:5, ore:5 , gold:2, desert:1}, numbers: [2,2, 3,3,3, 4,4,4, 5,5,5, 6,6,6, 8,8,8, 9,9,9, 10,10,10, 11,11,11, 12],
                ports: [
                    {q:-1, r:-1, e:3, t:'any'},
                    {q:1, r:-1, e:4, t:'ore'},
                    {q:1, r:0, e:5, t:'any'},
                    {q:-3, r:1, e:4, t:'sheep'},
                    {q:-3, r:1, e:2, t:'clay'},
                    {q:1, r:1, e:1, t:'wheat'},
                    {q:-3, r:3, e:3, t:'any'},
                    {q:-2, r:3, e:2, t:'forest'},
                    {q:-1, r:3, e:0, t:'any'}
                ]
            },
            5: { layout: ["lwmmmwl", "lwmmmmww", "lwmmmmmwl", "wwmmmmmmww", "lwmmmmmwl", "lwmmmmww", "lwmmmwl"], resources: {forest:7, wheat:7, sheep:7, clay:7, ore:7, gold:3, desert:2}, numbers: [2,2,2, 3,3,3,3, 4,4,4,4, 5,5,5,5, 6,6,6,6, 8,8,8,8, 9,9,9,9, 10,10,10,10, 11,11,11,11, 12,12,12], randomPorts: true, portLocations: [{q:2, r:-3, e:5}, {q:0, r:-2, e:4}, {q:3, r:-2, e:5}, {q:-1, r:-1, e:3}, {q:3, r:-1, e:0}, {q:-2, r:0, e:2}, {q:3, r:0, e:1}, {q:-2, r:2, e:2}, {q:1, r:2, e:0}, {q:-1, r:3, e:2}, {q:0, r:3, e:1}] }
        },
        islands: {
            3: { layout: ["wwmm", "mmwmm", "mmwmmw", "wwwwwww", "mmmwmm", "mmwmm", "mwww"], resources: {clay:4, forest:4, sheep:4, wheat:4, ore:4}, numbers: [2, 3,3, 4,4, 5,5,5, 6,6, 8,8, 9,9,9, 10,10, 11,11, 12], ports: [{q:3, r:-2, e:5, t:'any'}, {q:-2, r:-1, e:4, t:'any'}, {q:0, r:-2, e:1, t:'ore'}, {q:2, r:-1, e:2, t:'clay'}, {q:-3, r:1, e:5, t:'forest'}, {q:-3, r:1, e:2, t:'any'}, {q:2, r:1, e:1, t:'wheat'}, {q:-2, r:2, e:1, t:'sheep'}, {q:0, r:2, e:4, t:'any'}] },
            4: { layout: ["mwmm", "mwmmm", "mmwmmw", "wwwmwww", "mmwwmm", "mmmwm", "mmwm"], resources: {clay:4, forest:5, sheep:5, wheat:5, ore:4}, numbers: [2, 3,3, 4,4,4, 5,5,5, 6,6, 8,8, 9,9,9, 10,10,10, 11,11,11, 12], ports: [{q:-1, r:-2, e:3, t:'wheat'}, {q:3, r:-2, e:1, t:'forest'}, {q:-2, r:-1, e:1, t:'any'}, {q:0, r:0, e:4, t:'any'}, {q:-3, r:1, e:2, t:'clay'}, {q:2, r:1, e:4, t:'ore'}, {q:2, r:1, e:1, t:'any'}, {q:-2, r:2, e:5, t:'any'}, {q:-3, r:3, e:3, t:'sheep'}] },
            5: {
                layout: ["mmwmwmm", "mmwmmwmm", "mmwmmwwmw", "wwwwwwwwww", "wmwwmmwmm", "mmwmmwmm", "mmwmwmm"],
                resources: {clay:6, forest:7, sheep:7, wheat:6, ore:6},
                numbers: [2,2, 3,3,3, 4,4,4, 5,5,5, 6,6,6, 8,8,8, 9,9,9, 10,10,10, 11,11,11, 12,12, 4,5,9,10],
                randomPortsFromPool: true,
                portLocations: [{q:0, r:-3, e:4}, {q:2, r:-3, e:5}, {q:5, r:-3, e:5}, {q:-1, r:-2, e:1}, {q:4, r:-2, e:2}, {q:-2, r:-1, e:2}, {q:-4, r:2, e:3}, {q:3, r:2, e:0}, {q:-3, r:3, e:5}, {q:-1, r:2, e:2}, {q:1, r:3, e:2}]
            }
        }
    };

    SCENARIOS.base[6] = SCENARIOS.base[5];
    SCENARIOS.shores[6] = SCENARIOS.shores[5];
    SCENARIOS.islands[6] = SCENARIOS.islands[5];

    class CatanGenerator {
        constructor() {
            this.svg = document.getElementById('mapCanvas');
            this.container = document.getElementById('mapContainer');
            this.loading = document.getElementById('loadingOverlay');
            this.zoomSlider = document.getElementById('zoomSlider');
            this.state = { hexes: [], nodes: [], ports: [], roads: [], scale: 1, tx: 0, ty: 0, isPanning: false, start: { x: 0, y: 0 } };
            this.init();
        }

        init() {
            this.container.addEventListener('mousedown', e => { this.state.isPanning = true; this.state.start = { x: e.clientX - this.state.tx, y: e.clientY - this.state.ty }; });
            window.addEventListener('mousemove', e => { if (!this.state.isPanning) return; this.state.tx = e.clientX - this.state.start.x; this.state.ty = e.clientY - this.state.start.y; this.applyTransform(); });
            window.addEventListener('mouseup', () => this.state.isPanning = false);
            this.container.addEventListener('wheel', e => { e.preventDefault(); const d = e.deltaY > 0 ? 0.95 : 1.05; this.updateZoom(this.state.scale * d); }, { passive: false });
            this.zoomSlider.addEventListener('input', e => this.updateZoom(parseFloat(e.target.value)));
            ['showRoads'].forEach(id => document.getElementById(id).addEventListener('change', () => this.renderCurrent()));
            this.generate();
        }

        updateZoom(val) { this.state.scale = Math.min(Math.max(val, 0.4), 3); this.zoomSlider.value = this.state.scale; document.getElementById('zoomVal').textContent = Math.round(this.state.scale * 100) + '%'; this.applyTransform(); }
        applyTransform() { this.svg.style.transform = `translate(${this.state.tx}px, ${this.state.ty}px) scale(${this.state.scale})`; }

        async generate() {
            this.loading.classList.remove('hidden');
            await new Promise(r => setTimeout(r, 100));
            const pCount = parseInt(document.getElementById('playerCount').value);
            const sKey = document.getElementById('scenario').value;
            const cfg = SCENARIOS[sKey][pCount];
            document.getElementById('activeScenarioName').textContent = document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;

            let attempt = 0;
            while (attempt < 1500) {
                const map = this.createSkeleton(cfg);
                if (this.fillResources(map, cfg, sKey)) {
                    if (this.fillNumbers(map, cfg)) {
                        this.buildTopology(map);
                        this.placePorts(map, cfg);
                        this.placeBlockers(map, sKey, pCount);
                        const evalRes = this.evaluate(map, pCount, attempt > 500);
                        if (evalRes.isFair) {
                            this.state = { ...this.state, ...map, roads: evalRes.roads };
                            this.renderCurrent(evalRes);
                            break;
                        }
                    }
                }
                attempt++;
            }
            this.loading.classList.add('hidden');
        }

        createSkeleton(cfg) {
            const hexes = [];
            const tileCoords = new Set();
            const rOffset = Math.floor(cfg.layout.length / 2);

            cfg.layout.forEach((row, rIdx) => {
                const r = rIdx - rOffset;
                const qStart = Math.round(-((row.length - 1) / 2) - (r / 2));
                row.split('').forEach((char, qi) => {
                    const q = qStart + qi;
                    const canStart = char === 'm';
                    const isLand = char === 'm' || char === 'l';
                    tileCoords.add(`${q},${r}`);
                    hexes.push({
                        q, r,
                        canStart: canStart,
                        resource: isLand ? 'pending' : 'playableSea',
                        isTile: isLand,
                        number: 0, x:0, y:0
                    });
                });
            });

            const border = new Set();
            tileCoords.forEach(k => {
                const [q, r] = k.split(',').map(Number);
                [[1,0], [1,-1], [0,-1], [-1,0], [-1,1], [0,1]].forEach(d => {
                    const nk=`${q+d[0]},${r+d[1]}`;
                    if(!tileCoords.has(nk)) border.add(nk);
                });
            });
            border.forEach(k => {
                const [q,r] = k.split(',').map(Number);
                hexes.push({q, r, resource: 'border', number:0, isTile: false, canStart: false});
            });
            return { hexes, nodes: [], ports: [] };
        }

        getNeighbors(h, all) {
            const dirs = [[1,0], [1,-1], [0,-1], [-1,0], [-1,1], [0,1]];
            return all.filter(o => dirs.some(d => o.q === h.q+d[0] && o.r === h.r+d[1]));
        }

        getIslandMap(map) {
            const land = map.hexes.filter(h => h.isTile);
            const islands = [];
            const visited = new Set();

            land.forEach(h => {
                const key = `${h.q},${h.r}`;
                if (visited.has(key)) return;

                const island = [];
                const q = [h];
                visited.add(key);

                while (q.length > 0) {
                    const curr = q.shift();
                    island.push(curr);
                    this.getNeighbors(curr, land).forEach(nb => {
                        const nbKey = `${nb.q},${nb.r}`;
                        if (!visited.has(nbKey)) {
                            visited.add(nbKey);
                            q.push(nb);
                        }
                    });
                }
                islands.push(island);
            });
            return islands;
        }

        fillResources(map, cfg, sKey) {
            let pool = [];
            Object.entries(cfg.resources).forEach(([res, count]) => { for(let i=0; i<count; i++) pool.push(res); });
            const landTiles = map.hexes.filter(h => h.resource === 'pending');

            const placeWithSpacing = (tilesToFill, availablePool) => {
                const remaining = [...availablePool];
                this.shuffle(remaining);

                for (let attempt = 0; attempt < 100; attempt++) {
                    const localPool = [...remaining];
                    let conflict = false;

                    for (let i = 0; i < tilesToFill.length; i++) {
                        const tile = tilesToFill[i];
                        const neighbors = this.getNeighbors(tile, map.hexes);

                        let foundIndex = -1;
                        for (let j = 0; j < localPool.length; j++) {
                            const candidate = localPool[j];
                            if (!neighbors.some(nb => nb.resource === candidate)) {
                                foundIndex = j;
                                break;
                            }
                        }

                        if (foundIndex !== -1) {
                            tile.resource = localPool.splice(foundIndex, 1)[0];
                        } else {
                            tile.resource = localPool.shift();
                            conflict = true;
                        }
                    }
                    if (!conflict) return true;
                    this.shuffle(remaining);
                }
                return false;
            };

            // Wyizoluj z≈Çoto i pustyniƒô przed resztƒÖ (priorytet rozmieszczenia)
            const goldCount = cfg.resources.gold || 0;
            const desertCount = cfg.resources.desert || 0;
            const otherPool = pool.filter(r => r !== 'gold' && r !== 'desert');

            landTiles.forEach(h => h.resource = 'pending');

            // 1. Rozmie≈õƒá pustyniƒô (musi ≈ÇƒÖczyƒá siƒô z innym lƒÖdem)
            let desertsPlaced = 0;
            const desertCandidates = landTiles.filter(h =>
                this.getNeighbors(h, landTiles).length > 0
            );
            this.shuffle(desertCandidates);

            for (const cand of desertCandidates) {
                if (desertsPlaced >= desertCount) break;
                cand.resource = 'desert';
                desertsPlaced++;
            }

            // 2. Rozmie≈õƒá z≈Çoto (na wyspach zewnƒôtrznych, bez sƒÖsiedztwa i po jednym na wyspƒô)
            if (sKey === 'shores') {
                const islands = this.getIslandMap(map);
                const externalIslands = islands.filter(isl => isl.some(h => !h.canStart));
                let goldPlaced = 0;
                this.shuffle(externalIslands);

                for (const island of externalIslands) {
                    if (goldPlaced >= goldCount) break;
                    const candidates = island.filter(h => !h.canStart && h.resource === 'pending');
                    this.shuffle(candidates);

                    for (const cand of candidates) {
                        const nbGold = this.getNeighbors(cand, map.hexes).some(nb => nb.resource === 'gold');
                        if (!nbGold) {
                            cand.resource = 'gold';
                            goldPlaced++;
                            break;
                        }
                    }
                }
                // Fallback dla z≈Çota
                if (goldPlaced < goldCount) {
                    const fallbackCand = landTiles.filter(h => h.resource === 'pending' && !h.canStart);
                    this.shuffle(fallbackCand);
                    for (const c of fallbackCand) {
                        if (goldPlaced >= goldCount) break;
                        if (!this.getNeighbors(c, map.hexes).some(nb => nb.resource === 'gold')) {
                            c.resource = 'gold'; goldPlaced++;
                        }
                    }
                }
            }

            // 3. Wype≈Çnij resztƒô zasob√≥w z unikaniem sƒÖsiedztwa tych samych typ√≥w
            const remainingTiles = landTiles.filter(h => h.resource === 'pending');
            placeWithSpacing(remainingTiles, otherPool);

            if (document.getElementById('strictRules').checked) {
                const dList = landTiles.filter(x => x.resource === 'desert');
                for (const d of dList) { if (this.getNeighbors(d, map.hexes).some(n => n.resource === 'desert')) return false; }
            }
            return true;
        }

        fillNumbers(map, cfg) {
            const tiles = map.hexes.filter(h => h.isTile && h.resource !== 'desert');
            const pool = [...cfg.numbers];
            this.shuffle(pool);
            tiles.forEach((h, i) => {
                h.number = pool[i] || 0;
            });
            if (document.getElementById('strictRules').checked) {
                if (tiles.some(h => (h.number === 6 || h.number === 8) && this.getNeighbors(h, map.hexes).some(n => n.number === 6 || n.number === 8))) return false;
            }
            return true;
        }

        buildTopology(map) {
            const nM = new Map(); const size = 52;
            map.hexes.forEach(h => {
                const cx = 500 + size * Math.sqrt(3) * (h.q + h.r / 2), cy = 500 + size * (3/2) * h.r;
                h.x = cx; h.y = cy;
                for (let i=0; i<6; i++) {
                    const a = (Math.PI/180)*(60*i-30);
                    const vx = cx + size*Math.cos(a), vy = cy + size*Math.sin(a);
                    const k = `${Math.round(vx)},${Math.round(vy)}`;
                    if (!nM.has(k)) nM.set(k, { x: vx, y: vy, adj: [], neighbors: [], owner: null });
                    nM.get(k).adj.push(h);
                }
            });
            map.nodes = Array.from(nM.values());
            map.nodes.forEach(n => {
                n.totalPP = n.adj.reduce((s, h) => s + (PP_MAP[h.number] || 0), 0);
                map.nodes.forEach(o => { if (n !== o && Math.hypot(n.x-o.x, n.y-o.y) < 65) n.neighbors.push(o); });
            });
        }

        placePorts(map, cfg) {
            const size = 52;
            const getV = (hq, hr, corner) => {
                const cx = 500 + size * Math.sqrt(3) * (hq + hr / 2), cy = 500 + size * (3/2) * hr;
                const a = (Math.PI/180)*(60*corner-30);
                const vx = cx + size*Math.cos(a), vy = cy + size*Math.sin(a);
                return map.nodes.find(n => Math.hypot(n.x-vx, n.y-vy) < 5);
            };
            if (cfg.randomPorts || cfg.randomPortsFromPool) {
                const pool = cfg.randomPortsFromPool ? ['any','any','any','any','any','sheep','sheep','forest','clay','wheat','ore'] : ['any','any','any','sheep','forest','clay','wheat','ore'];
                this.shuffle(pool);
                cfg.portLocations.forEach((loc, i) => {
                    const n1 = getV(loc.q, loc.r, loc.e), n2 = getV(loc.q, loc.r, (loc.e+1)%6);
                    if (n1 && n2) map.ports.push({ n1, n2, type: pool[i] || 'any' });
                });
            } else if (cfg.ports) {
                cfg.ports.forEach(p => {
                    const n1 = getV(p.q, p.r, p.e), n2 = getV(p.q, p.r, (p.e+1)%6);
                    if (n1 && n2) map.ports.push({ n1, n2, type: p.t });
                });
            }
        }

        placeBlockers(map, sKey, pCount) {
            const desert = map.hexes.find(h => h.resource === 'desert');
            if (desert) desert.hasRobber = true;
            else {
                const h12 = map.hexes.find(h => h.number === 12);
                if(h12) h12.hasRobber = true;
            }
            if (sKey !== 'base') {
                const piratePos = (sKey === 'shores') ? (pCount >= 5 ? {q:5, r:0} : (pCount === 4 ? {q:4, r:0} : {q:3, r:0})) : (pCount >= 5 ? {q:-4, r:0} : {q:-2, r:4});
                const pHex = map.hexes.find(h => h.q === piratePos.q && h.r === piratePos.r);
                if (pHex) pHex.hasPirate = true;
            }
        }

        evaluate(map, pCount, relaxed) {
            const players = Array.from({length: pCount}, (_, i) => ({id: i+1, pp: 0, settlements: []}));
            const roads = []; const order = [...Array(pCount).keys(), ...[...Array(pCount).keys()].reverse()];
            const taken = new Set();
            for (const pIdx of order) {
                const candidates = map.nodes.filter(n => {
                    const isFar = Array.from(taken).every(t => Math.hypot(n.x-t.x, n.y-t.y) > 75);
                    const touchesMainIsland = n.adj.some(h => h.canStart);
                    return isFar && touchesMainIsland;
                });
                if (candidates.length === 0) return { isFair: false };
                candidates.sort((a, b) => b.totalPP - a.totalPP);
                const best = candidates[0]; best.owner = players[pIdx].id;
                players[pIdx].pp += best.totalPP; players[pIdx].settlements.push(best); taken.add(best);
                const rNode = best.neighbors.find(nn => !Array.from(taken).some(t => Math.hypot(nn.x-t.x, nn.y-t.y) < 10));
                if (rNode) roads.push({ n1: best, n2: rNode, owner: players[pIdx].id });
            }
            const pps = players.map(p => p.pp);
            const minPP = Math.min(...pps);
            return { isFair: minPP > 4 && (relaxed ? (Math.max(...pps)-minPP <= 8) : (Math.max(...pps)-minPP <= 5)), players, roads };
        }

        renderCurrent(evalRes) {
            this.svg.innerHTML = ''; const size = 52;
            const showRoads = document.getElementById('showRoads').checked;
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            this.state.hexes.forEach(h => {
                for (let i=0; i<6; i++) {
                    const a=(Math.PI/180)*(60*i-30);
                    const vx = h.x + size*Math.cos(a), vy = h.y + size*Math.sin(a);
                    minX = Math.min(minX, vx); maxX = Math.max(maxX, vx); minY = Math.min(minY, vy); maxY = Math.max(maxY, vy);
                }
            });
            const pad = 40;
            this.svg.setAttribute("viewBox", `${minX - pad} ${minY - pad} ${maxX - minX + pad*2} ${maxY - minY + pad*2}`);

            this.state.hexes.forEach(h => {
                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                const pts = [0,1,2,3,4,5].map(i => { const a=(Math.PI/180)*(60*i-30); return `${h.x + size*Math.cos(a)},${h.y + size*Math.sin(a)}`; }).join(" ");
                poly.setAttribute("points", pts); poly.setAttribute("class", "hex-path");
                poly.setAttribute("fill", h.resource === 'playableSea' ? COLORS.playableSea : (h.resource === 'border' ? COLORS.borderTile : COLORS[h.resource]));
                poly.onclick = () => this.showHexDetails(h); this.svg.appendChild(poly);

                if (h.isTile && h.resource !== 'desert' && h.resource !== 'border' && h.resource !== 'playableSea') {
                    const icon = document.createElementNS("http://www.w3.org/2000/svg", "use");
                    icon.setAttribute("href", `#icon-${h.resource}`); icon.setAttribute("x", h.x); icon.setAttribute("y", h.y);
                    icon.setAttribute("class", "resource-icon text-white"); icon.setAttribute("transform", `scale(1.4) translate(${h.x/-1.4}, ${h.y/-1.4})`);
                    this.svg.appendChild(icon);
                }
                if (h.number > 0) {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    c.setAttribute("cx", h.x); c.setAttribute("cy", h.y); c.setAttribute("r", "16"); c.setAttribute("fill", "white");
                    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    t.setAttribute("x", h.x); t.setAttribute("y", h.y+5); t.setAttribute("text-anchor", "middle"); t.setAttribute("class", "hex-label");
                    t.setAttribute("fill", (h.number === 6 || h.number === 8) ? "#ef4444" : "#1e293b"); t.textContent = h.number;
                    g.appendChild(c); g.appendChild(t); this.svg.appendChild(g);
                }
                if (h.hasRobber) {
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    r.setAttribute("d", `M${h.x-8},${h.y+10} L${h.x+8},${h.y+10} L${h.x+5},${h.y-12} C${h.x+5},${h.y-18} ${h.x-5},${h.y-18} ${h.x-5},${h.y-12} Z`);
                    r.setAttribute("class", "robber-icon"); this.svg.appendChild(r);
                }
                if (h.hasPirate) {
                    const p = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    p.innerHTML = `<path d="M${h.x-15},${h.y+5} Q${h.x},${h.y+15} ${h.x+15},${h.y+5} L${h.x+10},${h.y-5} L${h.x-10},${h.y-5} Z" class="pirate-icon" /><rect x="${h.x-1}" y="${h.y-15}" width="2" height="12" fill="white" />`;
                    this.svg.appendChild(p);
                }
            });
            this.state.ports.forEach(p => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", p.n1.x); line.setAttribute("y1", p.n1.y); line.setAttribute("x2", p.n2.x); line.setAttribute("y2", p.n2.y);
                line.setAttribute("class", "port-line"); this.svg.appendChild(line);
                const mx = (p.n1.x+p.n2.x)/2, my = (p.n1.y+p.n2.y)/2;
                const bg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                bg.setAttribute("cx", mx); bg.setAttribute("cy", my); bg.setAttribute("r", "12"); bg.setAttribute("class", "port-bg");
                bg.setAttribute("fill", p.type === 'any' ? '#1e293b' : COLORS[p.type]);
                bg.onclick = () => this.showPortDetails(p); this.svg.appendChild(bg);
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.setAttribute("x", mx); t.setAttribute("y", my+4); t.setAttribute("text-anchor", "middle"); t.setAttribute("class", "text-[9px] font-black");
                t.setAttribute("fill", (p.type==='wheat'||p.type==='sheep') ? '#1e293b' : 'white'); t.textContent = p.type==='any' ? '3:1' : '2:1';
                this.svg.appendChild(t);
            });
            if (showRoads) this.state.roads.forEach(r => {
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1", r.n1.x); l.setAttribute("y1", r.n1.y); l.setAttribute("x2", r.n2.x); l.setAttribute("y2", r.n2.y);
                l.setAttribute("class", `road-line road-${r.owner}`); this.svg.appendChild(l);
            });
            this.state.nodes.forEach(n => {
                if (n.owner) {
                    const g = document.createElementNS("http://www.w3.org/2000/svg", "g"); g.setAttribute("class", "node-marker"); g.onclick = () => this.showNodeDetails(n);
                    const c = document.createElementNS("http://www.w3.org/2000/svg", "circle"); c.setAttribute("cx", n.x); c.setAttribute("cy", n.y); c.setAttribute("r", "14"); c.setAttribute("class", `player-${n.owner}`);
                    const t = document.createElementNS("http://www.w3.org/2000/svg", "text"); t.setAttribute("x", n.x); t.setAttribute("y", n.y+5); t.setAttribute("text-anchor", "middle"); t.setAttribute("class", `font-black text-[12px] player-text-${n.owner} fill-white`); t.textContent = n.owner;
                    const b = document.createElementNS("http://www.w3.org/2000/svg", "text"); b.setAttribute("x", n.x); b.setAttribute("y", n.y-20); b.setAttribute("text-anchor", "middle"); b.setAttribute("class", "settlement-badge"); b.textContent = `${n.totalPP}p`;
                    g.appendChild(c); g.appendChild(t); g.appendChild(b); this.svg.appendChild(g);
                }
            });
            if (evalRes) this.updateStatsUI(evalRes.players);
            this.state.tx = 0; this.state.ty = 0; this.state.scale = 1;
            this.zoomSlider.value = 1; document.getElementById('zoomVal').textContent = '100%';
            this.applyTransform();
        }

        updateStatsUI(players) {
            const list = document.getElementById('playerStats'); list.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl bg-white border border-slate-100 shadow-sm transition-all hover:shadow-md border-l-4 border-player-${p.id}`;

                const resStats = { forest: 0, clay: 0, wheat: 0, sheep: 0, ore: 0, gold: 0 };
                p.settlements.forEach(s => {
                    s.adj.forEach(h => {
                        if (h.isTile && h.resource !== 'desert' && h.resource !== 'border' && h.resource !== 'playableSea') {
                            resStats[h.resource] += PP_MAP[h.number] || 0;
                        }
                    });
                });

                const resDisplay = Object.entries(resStats)
                    .filter(([_, val]) => val > 0)
                    .map(([res, val]) => `
                        <div class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100">
                            <div class="w-2.5 h-2.5 rounded-full" style="background: ${COLORS[res]}"></div>
                            <span class="text-[10px] font-bold text-slate-600">${val}</span>
                        </div>
                    `).join('');

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-lg player-${p.id} flex items-center justify-center text-[10px] font-black text-white shadow-sm border border-black/5">${p.id}</div>
                            <span class="font-black text-xs text-slate-400 uppercase tracking-tighter">Gracz ${p.id}</span>
                        </div>
                        <span class="text-sm font-black text-slate-800">${p.pp} PP</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-3">
                        <div class="stat-bar h-full bg-slate-800 rounded-full shadow-[0_0_10px_rgba(0,0,0,0.1)]" style="width: ${(p.pp/15)*100}%"></div>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mt-2">
                        ${resDisplay}
                    </div>
                `;
                list.appendChild(div);
            });
            document.getElementById('statsPanel').classList.remove('hidden');
        }

        showHexDetails(h) { this.openModal("Szczeg√≥≈Çy Pola", `<div class="p-8 rounded-3xl text-white text-center shadow-lg" style="background:${COLORS[h.resource] || COLORS.playableSea}"><div class="text-4xl font-black mb-2 italic tracking-tighter uppercase">${RESOURCE_LABELS[h.resource]}</div><div class="font-bold opacity-70">${h.number ? 'Produkcja: '+h.number : 'Brak produkcji'}</div></div><div class="grid grid-cols-2 gap-4 mt-4 text-slate-900"><div class="p-4 rounded-2xl bg-slate-50 border font-mono text-center">Q: ${h.q}, R: ${h.r}</div><div class="p-4 rounded-2xl bg-slate-50 border font-bold text-center uppercase text-[10px]">${h.hasRobber ? 'üë§ Z≈Çodziej' : (h.hasPirate ? 'üè¥‚Äç‚ò†Ô∏è Pirat' : 'Wolne')}</div><div class="col-span-2 p-3 bg-blue-50 text-blue-600 rounded-xl text-center text-[10px] font-bold uppercase tracking-widest">${h.canStart ? '‚úÖ Tu mo≈ºna zaczƒÖƒá grƒô' : '‚ùå Brak startu'}</div></div>`); }
        showNodeDetails(n) { this.openModal(n.owner ? `Osada Gracza ${n.owner}` : "Pusty Wƒôze≈Ç", `<div class="bg-slate-900 p-8 rounded-3xl text-white text-center"><div class="text-[10px] uppercase tracking-widest opacity-50 mb-1 text-center">Potencja≈Ç Produkcji</div><div class="text-6xl font-black text-center">${n.totalPP} <span class="text-xl opacity-30 italic">PP</span></div></div><div class="space-y-3 mt-4 text-slate-900">${n.adj.map(h => (h.isTile && h.resource !== 'border' && h.resource !== 'playableSea') ? `<div class="flex items-center justify-between p-3 bg-slate-50 border rounded-xl"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background:${COLORS[h.resource]}"></div><span class="font-bold text-slate-900">${RESOURCE_LABELS[h.resource]}</span></div><span class="font-black text-slate-900">${h.number || ''}</span></div>` : '').join('')}</div>`); }
        showPortDetails(p) { this.openModal("Szczeg√≥≈Çy Portu", `<div class="p-8 rounded-3xl text-white text-center shadow-lg" style="background:${p.type==='any'?'#1e293b':COLORS[p.type]}"><div class="text-6xl font-black mb-2 tracking-tighter">${p.type==='any'?'3:1':'2:1'}</div><div class="font-bold opacity-70 italic uppercase tracking-widest text-center">${RESOURCE_LABELS[p.type]}</div></div><p class="text-slate-500 font-medium text-center mt-4 px-4 text-xs">Pozwala na wymianƒô surowc√≥w w stosunku ${p.type==='any'?'3 do 1':'2 do 1 dla ' + RESOURCE_LABELS[p.type]} w banku.</p>`); }
        openModal(t, c) { document.getElementById('modalTitle').textContent = t; document.getElementById('modalContent').innerHTML = c; document.body.classList.add('modal-open'); document.getElementById('modalOverlay').classList.remove('hidden'); setTimeout(()=>document.getElementById('modalOverlay').classList.add('opacity-100'), 10); }
        closeModal() { document.body.classList.remove('modal-open'); document.getElementById('modalOverlay').classList.remove('opacity-100'); setTimeout(()=>document.getElementById('modalOverlay').classList.add('hidden'), 300); }
        shuffle(a) { for (let i = a.length-1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }
    }
    window.onload = () => { window.app = new CatanGenerator(); };
</script>
</body>
</html>